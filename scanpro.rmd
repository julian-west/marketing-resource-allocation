---
title: "SCAN*PRO"
author: "Julian West"
date: "25 March 2020"
output: 
  html_document:
    theme: cosmo
    fig_caption: yes
    number_sections: TRUE
    toc: TRUE
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r, echo=FALSE, warning=FALSE,message=FALSE}
library(readxl)
library(tidyr)
library(dplyr)
library(forecast)
library(ggplot2)
library(stargazer)
library(fastDummies)
```

# Abstract 
TODO

# Introduction

Retailers are interested in understanding the financial impact of promotional activity on product sales. The SCAN\*PRO model is a popular method for quantifying the interaction effects between various promotions and allows retail store managers to improve their promotional mix decisions. In this project, the SCAN\*PRO model will be used to understand the effects of promotional activity on the sales of three brands of beer for the Chicago based supermarket chain Dominick's. The insights gained from the model will be used to make recommendations to the store manager on how to improve total beer sales with an optimized promotional mix.

## Business Objective & Research Question

- How does feature and display promotional activity of each beer brand affect the sales of each beer brand? 

This analysis will look at promotional activity from the perspective of the store manager. It is assumed that the manager has full control over feature and display promotions and that there are no specific contractural obilgations with the brand supplier to promote the brand. The output of the SCAN*PRO model will direct the manager as to which form of promotion works best for each brand and how this may translate into increasing sales.


## About SCAN*PRO

SCAN*PRO is a store-level model which quantifies the effect of price changes and promotional activities on the sales of products for retailers. 

The model decomposes sales into: own and cross brand effects of price changes; display advertising and feature advertising; week/seasonal effects, store effects and random components.

.......

## Software Used

All analysis for this project was conducted using [R (programming language)](https://www.r-project.org/). Details of code and packages used are included in the Appendix.


# Dataset
The data consists of scanner records for beer category products from Dominick's Finer Foods (Dominick's). Dominick's was a Chicago-area grocery store chain before being [acquired by Safeway in 1998](https://en.wikipedia.org/wiki/Dominick%27s) and eventually closing in 2013. The original source of the dataset was [Chicago Booth Kilts Center for Marketing](https://www.chicagobooth.edu/research/kilts/datasets/dominicks), however, the dataset used for analysis was an adapted dataset shared by the Imperial College Retail Marketing analytics teaching team via Slack (beer_data_chicago_Dominicks.xslx).


The data covers 227 weeks (4 years 5 months) of sales for three brands of beer between 1989 and 1993. The raw data contains the following attributes for each brand:

- Sales
- Display
- Feature
- Price
- Retailer Margin
- Wholesale Price

The combined sales of the three brands is also included in the dataset.

The sales attribute is the weekly sales of each brand in dollars. The display and feature attributes are the percentage of stock keeping units (SKUs) of each brand which were promoted each week (Srinivasan et al, 2004). It is not clear from the literature what 'display' and 'feature' promotions specifically involved at the store so it is assumed that for a display promotion the product was displayed prominently in the store and for a feature promotion the product was 'on offer'. The price is the retail price of the brand in dollars. The wholesale price is the wholesale price of the product in dollars. It is unclear from the literature whether the retailer margin is in absolute or percentage terms. The retailer margin should be equal to the difference in sales price and wholesale price, however, this is not the case for the dataset so this attribute will be ignored as it is not important for the implementation of a SCAN*PRO model.

The .... talk about not using retailer margin and wholesale price etc.......


There were no missing observations in the dataset.

## Assumptions
The data is given at a weekly level and will therefore trace the impact of price/display promotions over a weekly time period. Therefore, it is assumed that each promotion lasts for one week.


## Exploratory Analysis 

```{r, results='asis'}
main_features <- c("Week",
                  "CategorySales",
                  "SALESBRAND1",
                  "SALESBRAND2",
                  "SALESBRAND3",
                  "PRICEBRAND1",
                  "PRICEBRAND2",
                  "PRICEBRAND3",
                  "display_brand1",
                  "display_brand2",
                  "display_brand3",
                  "FEATUREBRAND1",
                  "FEATUREBRAND2",
                  "FEATUREBRAND3")
              
add_features <- c("RETAILERMARGINBRAND1",
                  "RETAILERMARGINBRAND2",
                  "RETAILERMARGINBRAND3",
                  "WHOLESALEPRICE1",
                  "WHOLESALEPRICE2",
                  "WHOLESALEPRICE3")


data <- read_excel("./data/beer_data_chicago_Dominicks.xlsx")

store_data <- data %>% select(main_features)
stargazer(head(store_data),summary=FALSE, type='html',rownames=FALSE)

```

```{r}
stl(ts(store_data$CategorySales,frequency = 52), s.window = 'periodic') %>% 
  autoplot + 
  theme_minimal() +
  ggtitle("Total beer category sales, trend and seasonality") +
  xlab("Months")
```


The figure above shows the time series decomposition of the total beer category sales. The combined sales of the three beer brands fluctuates between \$40,000 and \$140,000 each week. The time series decomposition shows that there is no significant trend over time, however, there is a significant seasonal component to beer sales. This seasonal trend is also present in each individual brand.

```{r, echo=FALSE}
plot_variable_by_brand <- function(data, variable, title, ylabel){
  #plots specified variable by brand
  
  #select cols and reshape dataframe
  df_data <- data %>%
    select(Week, paste0(variable,"1"), paste0(variable,"2"), paste0(variable,"3")) %>%
    gather(key="variable",value="value", -Week)


  return (ggplot(df_data, aes(x=Week, y=value)) +
    geom_line(aes(color=variable), size=1) +
    scale_color_manual(values = c("#00AFBB", "#E7B800", "#ff0000")) +
    theme_minimal() +
    ggtitle(title) +
    ylab(ylabel))
}
```


```{r, echo=FALSE}
plot_variable_by_brand(data,"SALESBRAND","Weekly Sales by Brand","Sales ($)")
plot_variable_by_brand(data,"PRICEBRAND","Weekly Prices by Brand","Prices ($)")
plot_variable_by_brand(data,"FEATUREBRAND","Weekly featured products by brand", "Percentage of SKUs")
plot_variable_by_brand(data,"display_brand","Weekly displayed products by brand","Percentage of SKUs")

```

The sales chart shows that brands 1 and 2 have similar sales levels while brand 3 has much lower sales. The prices for each brand are similar and fluctuate between approximately \$4.0 and \$5.25. However, brand number 3 greatly reduced its retail price to below \$3.5 in a couple of the weeks recorded in the dataset. Brand 1 had the most number of weeks with featured products and generally had a greater number of SKUs featured each week. Brand 2 had a low by consistent level of featured products, however, brand 3 did not have any featured products until late in the time period where there were a significant spike in the percentage of SKUs featured. The percentage of SKUs displayed for each brand fluctuated greatly between 0% and 40% for brand 1 and 3, whereas brand 2 had a more consistent level of display SKUs at approximately 15% each week. 


# Modelling & Results
## Methodology
The SCAN*PRO model can be estimated using nonlinear estimation methods in its multiplicative form. However, the model parameters can be more easily estimated by taking a log transformation and using linear estimation methods. Linear estimation methods are preferred as linear models give a consistent set of model parameters whereas the parameters of nonlinear methods can be very sensitive to the optimization starting value, learning rate etc. and may not converge to the global minimum. The log transformed model can be specified as:

**MODEL EQUATION**


Three models were estimated, one for the sales of each brand.

### Data Preprocessing
As highlighted in the exploratory data analysis, the beer category sales are highly seasonal, therefore, in order to incorporate this seasonality component into the model 12 dummy variables were created for each month of the year. The price of each brand was log transofrmed without any preprocessing. The 'display' variable for each brand was transformed using a log(x+1) transformation. A log(x+1) transformation was used due to the small number of 0 values in the dataset. The 'featured' variables, however, contained mostly zero values and therefore could not be log transformed using a log(x+1) transformation (Wooldridge p 173). The 'featured' variable was transformed into a binary variable with a value of 1 if greater than 1% percentage of SKUs were featured and 0 otherwise.

- log transform price
- seaonsal dummay variables
- binary featured


### Model Validation
To validate the model, 75% of the data (170 observations) was randomly sampled for use in model parameter estimation with 25% left for model validation (57 observations) as consistent with the literature (Andrews, 2008). 


```{r}
set.seed(42)

SPLIT = 0.75
smp_size <- floor(nrow(store_data)*SPLIT)

train_ind <- sample(seq_len(nrow(store_data)), size = smp_size)

train <- store_data[train_ind, ]
test <- store_data[-train_ind, ]
```


```{r}
store_data$Month <- format(seq(as.Date('1989/09/01'),by='week',length.out = nrow(store_data)),"%B")

#seasonal variable
store_data <- fastDummies::dummy_cols(store_data)
```

```{r}
bran1_df <- store_data %>%
  select(-CategorySales,-SALESBRAND2,-SALESBRAND3)
```

------ TODO: Make the binary variables for featured --------

```{r}
store_data
```


```{r}
#feature binary variables
store_data$FEATUREBRAND1_BINARY <- ifelse(store_data$FEATUREBRAND1>0.01, 1, 0)
store_data$FEATUREBRAND2_BINARY <- ifelse(store_data$FEATUREBRAND2>0.01, 1, 0)
store_data$FEATUREBRAND3_BINARY <- ifelse(store_data$FEATUREBRAND3>0.01, 1, 0)
```


```{r}
log_transform <- function(x){return(log(x+1))}

log_cols <- 

```


```{r}
#brand 1 model


feature_cols <- c(
  "SALESBRAND1",
  
  # PRICES
  "PRICEBRAND1",
  "PRICEBRAND2",
  "PRICEBRAND3",
  
  # log display
  "display_brand1"       "display_brand2"      
[11] "display_brand3"       "FEATUREBRAND1"        "FEATUREBRAND2"        "FEATUREBRAND3"        "Month"               
[16] "Month_April"          "Month_August"         "Month_December"       "Month_February"       "Month_January"       
[21] "Month_July"           "Month_June"           "Month_March"          "Month_May"            "Month_November"      
[26] "Month_October"        "Month_September"      "FEATUREBRAND1_BINARY" "FEATUREBRAND2_BINARY" "FEATUREBRAND3_BINARY"
)


store_data %>% select(FEATUREBRAND1, FEATUREBRAND1_BINARY)
```


## Results

```{r}

# log_transform <- function(x){return(log(x+1))}
# 
# brand1 <- store_data %>% 
#   select(-Week,-CategorySales,-SALESBRAND2,-SALESBRAND3) %>%
#   lapply(log_transform) %>%
#   as.data.frame()
# 
# brand1.model <- lm(SALESBRAND1 ~ ., data=brand1)
# summary(brand1.model)
# 
# 
# brand2 <- store_data %>% 
#   select(-Week,-CategorySales,-SALESBRAND1,-SALESBRAND3) %>%
#   lapply(log_transform) %>%
#   as.data.frame()
# 
# brand2.model <- lm(SALESBRAND2 ~ ., data=brand2)
# summary(brand2.model)
# 
# 
# brand3 <- store_data %>% 
#   select(-Week,-CategorySales,-SALESBRAND1,-SALESBRAND2) %>%
#   lapply(log_transform) %>%
#   as.data.frame()
# 
# brand3.model <- lm(SALESBRAND3 ~ ., data=brand3)
# summary(brand3.model)
# 
# 
# 
# categoryTotal <- store_data %>% 
#   select(-Week,-SALESBRAND1,-SALESBRAND2, -SALESBRAND3) %>%
#   lapply(function(x){return(log(x+0.001))}) %>%
#   as.data.frame()
# 
# categoryTotal.model <- lm(CategorySales ~ ., data=categoryTotal)
# summary(categoryTotal.model)
```



Table of coefficients.... brief explanation. Model validation of test data

# Discussion
Interpretation of model coefficients.....

# Conclusions

## Recommendations to management
How should management act on the results of the model. What could be the uplift in sales?

## Model Improvements
What are the main assumptions of the model. What factors are missing from the dataset? What other techniques have been used?


# References
